FROM mcr.microsoft.com/dotnet/sdk:8.0

WORKDIR /app

# Copy everything needed for the test project
COPY src/OfflineSpeechTranslation/Models/ src/OfflineSpeechTranslation/Models/
COPY src/OfflineSpeechTranslation/Services/StreamingChunkManager.cs src/OfflineSpeechTranslation/Services/
COPY src/OfflineSpeechTranslation/Services/ModelDownloader.cs src/OfflineSpeechTranslation/Services/
COPY src/OfflineSpeechTranslation/Services/EngineFactory.cs src/OfflineSpeechTranslation/Services/
COPY src/OfflineSpeechTranslation/Services/SystemMetrics.cs src/OfflineSpeechTranslation/Services/
COPY src/OfflineSpeechTranslation/Interfaces/ src/OfflineSpeechTranslation/Interfaces/
COPY src/OfflineSpeechTranslation/Engines/ src/OfflineSpeechTranslation/Engines/
COPY src/OfflineSpeechTranslation/Interop/ src/OfflineSpeechTranslation/Interop/
COPY src/OfflineSpeechTranslation/Utilities/WavWriter.cs src/OfflineSpeechTranslation/Utilities/
COPY src/OfflineSpeechTranslation/Utilities/SessionFileManager.cs src/OfflineSpeechTranslation/Utilities/
COPY src/OfflineSpeechTranslation/Utilities/ZipExporter.cs src/OfflineSpeechTranslation/Utilities/
COPY src/OfflineSpeechTranslation/Utilities/EvidenceSession.cs src/OfflineSpeechTranslation/Utilities/
COPY src/OfflineSpeechTranslation/Utilities/ModelEvidence.cs src/OfflineSpeechTranslation/Utilities/
COPY tests/OfflineSpeechTranslation.Tests/ tests/OfflineSpeechTranslation.Tests/

# Restore and build
RUN dotnet restore tests/OfflineSpeechTranslation.Tests/OfflineSpeechTranslation.Tests.csproj
RUN dotnet build tests/OfflineSpeechTranslation.Tests/OfflineSpeechTranslation.Tests.csproj -c Release --no-restore

# Run tests
ENTRYPOINT ["dotnet", "test", "tests/OfflineSpeechTranslation.Tests/OfflineSpeechTranslation.Tests.csproj", "-c", "Release", "--no-build", "--verbosity", "normal", "--logger", "trx;LogFileName=test-results.trx"]
